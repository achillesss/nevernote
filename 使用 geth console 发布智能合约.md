### 使用 geth console 发布智能合约

geth console 中很早就去除了 eth.getCompilers() 以及编译合约的相关方法，但是依旧可以使用 geth 发布合约。方法如下：

1. 拥有一个solidity编译程序，可以是某个[在线编译的网站](https://ethereum.github.io/browser-solidity/)；也可以是一个离线的编译程序例如[solcjs](https://github.com/ethereum/solc-js)。无论是什么样的编译方法，目的只有一个：**将合约文件xxx.sol编译成一个xxx.abi的json文件与一个xxx.bin的binary文件**

2. 写一个简单的合约_``myContract.sol``_例如：

	```javascript
	pragma solidity ^0.4.8;
		contract token {
	    string public name;
	    string public symbol;
	    uint8 public decimals;
	    
	    mapping (address => uint256) public balanceOf;
	
	    event Transfer(address indexed from, address indexed to, uint256 value);
	
	    function token(
	        string tokenName,
	        uint8 decimalUnits,
	        string tokenSymbol
	        ) {
	        balanceOf[msg.sender] = 999999999999999999;
	        name = tokenName;
	        symbol = tokenSymbol;
	        decimals = decimalUnits;
	    }
	
	    function transfer(address _to, uint256 _value) {
	        require(balanceOf[msg.sender] >= _value);           // Check if the sender has enough
	        require(balanceOf[_to] + _value >= balanceOf[_to]); // Check for overflows
	        balanceOf[msg.sender] -= _value;                     // Subtract from the sender
	        balanceOf[_to] += _value;                            // Add the same to the recipient
	        Transfer(msg.sender, _to, _value);                   // Notify anyone listening that this transfer took place
	    }
	}
	```
	
	之后，例如我安装了solcjs，使用命令``solc --abi --bin myContract.sol``，之后便会在同目录下生成*``myContract.abi``*（这是一行有点长的JSON，下文简称**abi文件**）：
	
	```JSON
	[{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"u.
	int8"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"tokenName","type":"string"},{"name":"decimalUnits","type":"uint8"},{"name":"tokenSymbol","type":"string"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"}]
	```
	
	以及_``myContract.bin``_（这是一行有点长的数字，下文简称**bin文件**）：
	
	```TEXT
	6060604052341561000f57600080fd5b60405161074a38038061074a833981016040528080518201919060200180519060200190919080518201919050505b670de0b6b3a763ffff600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555082600090805190602001906100a09291906100dc565b5080600190805190602001906100b79291906100dc565b5081600260006101000a81548160ff021916908360ff1602179055505b505050610181565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061011d57805160ff191683800117855561014b565b8280016001018555821561014b579182015b8281111561014a57825182559160200191906001019061012f565b5b509050610158919061015c565b5090565b61017e91905b8082111561017a576000816000905550600101610162565b5090565b90565b6105ba806101906000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde031461006a578063313ce567146100f957806370a082311461012857806395d89b4114610175578063a9059cbb14610204575b600080fd5b341561007557600080fd5b61007d610246565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100be5780820151818401525b6020810190506100a2565b50505050905090810190601f1680156100eb5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561010457600080fd5b61010c6102e4565b604051808260ff1660ff16815260200191505060405180910390f35b341561013357600080fd5b61015f600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506102f7565b6040518082815260200191505060405180910390f35b341561018057600080fd5b61018861030f565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101c95780820151818401525b6020810190506101ad565b50505050905090810190601f1680156101f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561020f57600080fd5b610244600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919080359060200190919050506103ad565b005b60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102dc5780601f106102b1576101008083540402835291602001916102dc565b820191906000526020600020905b8154815290600101906020018083116102bf57829003601f168201915b505050505081565b600260009054906101000a900460ff1681565b60036020528060005260406000206000915090505481565b60018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103a55780601f1061037a576101008083540402835291602001916103a5565b820191906000526020600020905b81548152906001019060200180831161038857829003601f168201915b505050505081565b80600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101515156103fb57600080fd5b600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205481600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054011015151561048a57600080fd5b80600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254039250508190555080600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a35b50505600a165627a7a72305820214441d9d8d6190d6859b4ed29be7aa8b59b4359df4e8b668fd11737d2a4f6d00029
	```
	
3. 运行一个全节点的 geth，最好是私链（方便挖矿），开启 console，输入如下代码：

	```javascript
	// 首先将 abi 和 bin 文件分别赋值给一个变量，方便后面操作
	// 在赋值 bin 文件之前，在最前面添加一个 `0x`
	abi = [{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"tokenName","type":"string"},{"name":"decimalUnits","type":"uint8"},{"name":"tokenSymbol","type":"string"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"}]
	bin = '0x6060604052341561000f57600080fd5b60405161074a38038061074a833981016040528080518201919060200180519060200190919080518201919050505b670de0b6b3a763ffff600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555082600090805190602001906100a09291906100dc565b5080600190805190602001906100b79291906100dc565b5081600260006101000a81548160ff021916908360ff1602179055505b505050610181565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061011d57805160ff191683800117855561014b565b8280016001018555821561014b579182015b8281111561014a57825182559160200191906001019061012f565b5b509050610158919061015c565b5090565b61017e91905b8082111561017a576000816000905550600101610162565b5090565b90565b6105ba806101906000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde031461006a578063313ce567146100f957806370a082311461012857806395d89b4114610175578063a9059cbb14610204575b600080fd5b341561007557600080fd5b61007d610246565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100be5780820151818401525b6020810190506100a2565b50505050905090810190601f1680156100eb5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561010457600080fd5b61010c6102e4565b604051808260ff1660ff16815260200191505060405180910390f35b341561013357600080fd5b61015f600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506102f7565b6040518082815260200191505060405180910390f35b341561018057600080fd5b61018861030f565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101c95780820151818401525b6020810190506101ad565b50505050905090810190601f1680156101f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561020f57600080fd5b610244600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919080359060200190919050506103ad565b005b60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102dc5780601f106102b1576101008083540402835291602001916102dc565b820191906000526020600020905b8154815290600101906020018083116102bf57829003601f168201915b505050505081565b600260009054906101000a900460ff1681565b60036020528060005260406000206000915090505481565b60018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103a55780601f1061037a576101008083540402835291602001916103a5565b820191906000526020600020905b81548152906001019060200180831161038857829003601f168201915b505050505081565b80600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101515156103fb57600080fd5b600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205481600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054011015151561048a57600080fd5b80600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254039250508190555080600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a35b50505600a165627a7a72305820214441d9d8d6190d6859b4ed29be7aa8b59b4359df4e8b668fd11737d2a4f6d00029'

	// 通过 abi 文件初始化一个合约
	newContract = eth.contract(abi)

	// 选择一个发布合约的账户，将其解锁
	deployMan = eth.accounts[0]
	personal.unlockAccount(deployMan)
	
	// geth 使用一笔交易来发布合约，准备好发布合约的语句
	// 'from' 表示发布合约的人
	// 'data' 为合约的二进制数据
	// `gas` 应该发布者发起这笔交易所拿出的gas（有待验证），如果是这样，这个值应该设置成一个较大的值，以保证合约不会因为gas太少而发布不成功
	transactionDeploy = {from:deployMan,data:bin,gas:1000000}
	
	// 发布合约
	newContractPartialInstance = newContract.new(transactionDeploy)
	
	// 挖矿以记录合约
	miner.start()
	miner.stop()
	
	// 合约的全部实例
	newContractInstance = newContract.at(newContractPartialInstance.address)
	
	// 接下来就可以通过合约实例 newContractInstance 调用合约中的方法了
	// 本合约中有一个转移token的方法，可以通过如下命令转移token

	// 首先解锁拥有token的账户deployMan
	personal.unlockAccount(deployMan)

	// 调用合约中的方法给另外一个账户receiver发送999个token
	// 下面中的 `{from:deployMan}` 一定不能丢，因为调用合约中的方法是需要消耗gas的，这个gas就是从这个结构中的 from 来
	receiver = eth.accounts[1]
	newContractInstrance.transfer(receiver, 999, {from:deployMan})

	// 挖矿
	miner.start()
	miner.stop()

	// 将合约token添加进钱包可以查看，此时receiver账户中的确多了999个token
	```


4. 此时通过 geth 发布了合约，钱包中是无法看到这个合约的，因为合约不是通过钱包发布的。所以还需要在钱包中将此合约进行观察。通过``newContractPartialInstance.address``可以获取到合约的地址，此时在钱包中观察这个钱包的地址，并将abi文件粘贴到需要的json表格中，就能观察这个合约并调用其中的方法了
